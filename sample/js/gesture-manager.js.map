{"version":3,"file":"gesture-manager.js","sources":["../src/vector.js","../src/event.js","../src/listener.js","../src/gesture-manager.js","../src/gesture-manager-factory.js"],"sourcesContent":["/*\n * GestureManager\n *\n * Copyright (c) 2019 Kazuyoshi Tomita\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nexport default class Vector {\n  constructor(x, y) {\n    if (typeof x == \"undefined\") {\n      x = 0;\n    }\n    if (typeof y == \"undefined\") {\n      y = 0;\n    }\n\n    this.x = x;\n    this.y = y;\n  }\n\n  clone() {\n    return new Vector(this.x, this.y);\n  }\n  get size() {\n    return Math.sqrt(this.x * this.x + this.y * this.y);\n  }\n\n  plus(vec) {\n    this.x += vec.x;\n    this.y += vec.y;\n    return this;\n  }\n\n  minus(vec) {\n    this.x -= vec.x;\n    this.y -= vec.y;\n    return this;\n  }\n\n  scale(val) {\n    this.x *= val;\n    this.y *= val;\n    return this;\n  }\n\n  dot(vec) {\n    return this.x * vec.x + this.y * vec.y;\n  }\n\n  normalize() {\n    var size = this.size;\n    this.x /= size;     // sizeのnot zero保証は呼出側で。\n    this.y /= size;\n    return this;\n  }\n\n  // ベクトルのx軸に対する角度(0-2*PI)を返す。\n  // 時計回りを正方向とする。\n  angle() {\n    var vsize = this.size;\n\n    if (vsize < 1)\n      return 0;\n\n    var cosTh = this.x / vsize;\n    var rad = Math.acos(cosTh);\n\n    // PI - 2*PI\n    if (this.y < 0)\n      rad = Math.PI + Math.PI - rad;\n\n    return rad;\n  }\n\n  // radだけ回転させたベクトルを求める。\n  // rPoint(Vector)を指定すると、その点を中心とした回転となる。\n  rotate(rad, rPoint) {\n    if (typeof rPoint == \"undefined\")\n      rPoint = new Vector(0, 0);\n\n    var cosTh = Math.cos(rad);\n    var sinTh = Math.sin(rad);\n\n    var x = this.x - rPoint.x;\n    var y = this.y - rPoint.y;\n\n    this.x = cosTh * x - sinTh * y + rPoint.x;\n    this.y = sinTh * x + cosTh * y + rPoint.y;\n\n    return this;\n  }\n}\n","/*\n * GestureManager\n *\n * Copyright (c) 2019 Kazuyoshi Tomita\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nexport default class Event {\n  constructor(name) {\n    this.name = name;\n  }\n}\n\n","/*\n * GestureManager\n *\n * Copyright (c) 2019 Kazuyoshi Tomita\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nexport default function mixinListener(object, prop) {\n  object[prop] = {};\n\n  // メソッドを登録\n  object.addEventListener = function (name, func) {\n    if (!object[prop][name]) {\n      object[prop][name] = new ListenerList;\n    }\n    object[prop][name].addListener(func);\n  }\n  object.removeEventListener = function (name, func) {\n    if (!object[prop][name])\n      return;\n    object[prop][name].removeListener(func);\n  }\n  object.dispatchEvent = function (event) {\n    if (!object[prop][event.name])\n      return;\n    object[prop][event.name].fire(event);\n  }\n}\n\nclass ListenerList {\n  constructor() {\n    this.list = [];\n  }\n\n  addListener(func) {\n    this.list.push(func);\n  }\n\n  removeListener(func) {\n    for (var i = 0 ; i < this.list.length ; i++) {\n      if (this.list[i] == func) {\n        this.list.splice(i, 1);\n        return;\n      }\n    }\n  }\n\n  fire() {\n    for (var i = 0 ; i < this.list.length ; i++) {\n      (this.list[i]).apply(this, arguments);\n    }\n  }\n}\n","/*\n * GestureManager\n *\n * Copyright (c) 2019 Kazuyoshi Tomita\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nimport Vector from './vector.js';\nimport Event from './event.js';\nimport mixinListener from './listener.js';\n\n/* Memo:\n * [タップ判定の条件]\n * 以下の条件を全て満す時にタップイベントを発生させる。\n * (1) タッチしてから指が離れるまでに移動がないこと\n * (2) タッチしてから指が離れるまでにジェスチャが入らないこと\n * (3) タッチしてから指が離れるまで0.5sec以内であること\n *\n * [ダブルタップ判定の条件]\n * 前回のタップから0.5sec以内にタップが発生した場合、ダブルタップイベントを発生させる。\n * 前回のタップとの位置関係は現在考慮していない。\n */\n\nexport default class GestureManager {\n  constructor(nd) {\n    this.node = nd;\n    this.tapWork = {touchX: null,\n                    touchY: null,\n                    touchTime: null,\n                   };\n    this.lastTap = null;\n    this.gestureWork = {startPinchDistance: null, // gesture開始時の指の距離\n                        startAngle: 0,            // gesture開始時の角度(度)\n                        startCenter: null,        // gesture開始時の中心座標\n                       };\n    this.emulateGestureEvent = false;\n\n    this.eventHandlers = {touchstart: (event) => {this.touchStart(event)},\n                          touchmove:  (event) => {this.touchMove(event)},\n                          touchend:   (event) => {this.touchEnd(event)},\n                          gesturestart:  (event) => {this.gestureStart(event)},\n                          gesturechange: (event) => {this.gestureChange(event)},\n                          gestureend:    (event) => {this.gestureEnd(event)}};\n    for (var evname in this.eventHandlers) {\n      nd.addEventListener(evname, this.eventHandlers[evname], false);\n    }\n\n    var ua = navigator.userAgent.toLowerCase();\n    if (ua.indexOf('android') != -1) {\n      if (ua.match(/android\\s+([0-9.]+)/)) {\n\tvar osVersionString = RegExp.$1;\n        if (parseFloat(osVersionString) >= 4.0) {\n          this.emulateGestureEvent = true;\n        }\n      }\n    }\n  }\n\n  unbindEvent() {\n    for (var evname in this.eventHandlers) {\n      this.node.removeEventListener(evname, this.eventHandlers[evname], false);\n    }\n  }\n\n  gestureStart(event) {\n    var e = new Event('gesturestart');\n    this.dispatchEvent(e);\n  }\n\n  gestureChange(event) {\n    //console.log(event.scale + ':' + event.rotation);\n    var e = new Event('gesturechange');\n    e.scale = event.scale;\n    e.rotation = event.rotation;\n    e.center = this.gestureWork.startCenter;\n    this.dispatchEvent(e);\n\n    event.preventDefault();\n  }\n\n  gestureEnd(event) {\n    var e = new Event('gestureend');\n    this.dispatchEvent(e);\n  }\n\n\n  touchStart(event) {\n\n    var now = new Date;\n    if (event.touches.length == 1) {\n      this.tapWork.touchX = event.touches[0].clientX;\n      this.tapWork.touchY = event.touches[0].clientY;\n      this.tapWork.touchTime = now.getTime();\n    } else {\n      // ジェスチャーが入ったらtapはキャンセル      \n      this.tapWork.touchTime = null;\n    }\n\n    if (event.touches.length == 2) {\n      var vec = new Vector(event.touches[1].clientX - event.touches[0].clientX,\n                           event.touches[1].clientY - event.touches[0].clientY);\n      this.gestureWork.startPinchDistance = vec.size;\n      this.gestureWork.startAngle = vec.angle() * 180.0 / Math.PI;\n      this.gestureWork.startCenter = new Vector((event.touches[1].clientX + event.touches[0].clientX) / 2,\n                                                (event.touches[1].clientY + event.touches[0].clientY) / 2);\n      // XXX Android4 ではマルチタッチは検出できるようになったが、gesture eventは発行されないので、擬似的に処理する\n      if (this.emulateGestureEvent) {\n        this.gestureStart(event);\n      }\n    }\n\n    event.preventDefault(); // disable copy and paste\n  }\n\n  touchMove(event) {\n    // 移動があったらtapはキャンセル(わずかな移動は許容)\n    if (this.tapWork.touchTime &&\n        (Math.abs(event.touches[0].clientX - this.tapWork.touchX) > 3 ||\n         Math.abs(event.touches[0].clientY - this.tapWork.touchY) > 3)) {\n      this.tapWork.touchTime = null;\n    }\n\n    // ピンチ時の中心座標\n    if (event.touches.length >= 2) {\n      if (this.emulateGestureEvent) {\n        var vec = new Vector(event.touches[1].clientX - event.touches[0].clientX,\n                             event.touches[1].clientY - event.touches[0].clientY);\n        var currentPinchDistance = vec.size;\n        var currentAngle = vec.angle() * 180.0 / Math.PI;\n        event.scale = currentPinchDistance / this.gestureWork.startPinchDistance;\n        event.rotation = currentAngle - this.gestureWork.startAngle;\n        this.gestureChange(event);\n      }\n    }\n\n    event.preventDefault();\n  }\n\n  touchEnd(event) {\n\n    if (event.touches.length == 0 && this.tapWork.touchTime !== null) {\n      var now = new Date;\n      if (now.getTime() - this.tapWork.touchTime < 500) {\n        var e = new Event('tap');\n        e.clientX = this.tapWork.touchX;\n        e.clientY = this.tapWork.touchY;\n        this.dispatchEvent(e);\n\n        var doubleTapped = false;\n        if (this.lastTap) {\n          if (now.getTime() - this.lastTap.time < 500) {\n            // XXX lastTapとの座標のずれもチェックした方がいいか？\n            var e = new Event('doubletap');\n            e.clientX = this.tapWork.touchX;\n            e.clientY = this.tapWork.touchY;\n            this.dispatchEvent(e);\n\t    event.preventDefault();\n            doubleTapped = true;\n          }\n        }\n\n        if (!doubleTapped) {\n          this.lastTap = {x: this.tapWork.touchX,\n                          y: this.tapWork.touchY,\n                          time: now.getTime()};\n        } else {\n          // 再タップでdoubletapが再度発生しないように、タップ情報はクリア\n          this.lastTap = null;\n        }\n      }\n    }\n\n    if (this.emulateGestureEvent && event.touches.length == 1) {\n      this.gestureEnd(event);\n    }\n  }\n}\n\nmixinListener(GestureManager.prototype, 'listeners');\n","/*\n * GestureManager\n *\n * Copyright (c) 2019 Kazuyoshi Tomita\n *\n * This software is released under the MIT License.\n * https://opensource.org/licenses/MIT\n */\n\nimport GestureManager from './gesture-manager.js';\n\nexport default function createGestureManager(element) {\n  if (typeof element == 'string') {\n    element = document.querySelector(element);\n  }\n\n  return new GestureManager(element);\n}\n"],"names":["Vector","x","y","vec","val","size","vsize","cosTh","rad","Math","acos","PI","rPoint","cos","sinTh","sin","sqrt","Event","name","mixinListener","object","prop","addEventListener","func","ListenerList","addListener","removeEventListener","removeListener","dispatchEvent","event","fire","list","push","i","length","splice","apply","arguments","GestureManager","nd","node","tapWork","touchX","touchY","touchTime","lastTap","gestureWork","startPinchDistance","startAngle","startCenter","emulateGestureEvent","eventHandlers","touchstart","touchStart","touchmove","touchMove","touchend","touchEnd","gesturestart","gestureStart","gesturechange","gestureChange","gestureend","gestureEnd","evname","ua","navigator","userAgent","toLowerCase","indexOf","match","osVersionString","RegExp","$1","parseFloat","e","scale","rotation","center","preventDefault","now","Date","touches","clientX","clientY","getTime","angle","abs","currentPinchDistance","currentAngle","doubleTapped","time","prototype","createGestureManager","element","document","querySelector"],"mappings":"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"}